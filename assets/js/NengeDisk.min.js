class NengeDisk{ready=[];RegExpPaths=[];constructor(t,e,s){this.pathinfo=e,this.dbName=t,this.Store="undefined"!=typeof Nenge?Nenge.getStore(t):this.getIndexedDB(t),s&&this.SetModule(s)}SetModule(t){Object.defineProperty(this,"Module",{get:()=>t}),this.FS&&Object.keys(this.pathinfo).forEach((t=>{this.RegExpPaths.push(new RegExp("^"+t.replace("/","\\/"))),this.FS.mkdir(t),this.FS.mount(this,{},t)})),this.MEMFS&&this.setMEMFS()}get FS(){return this.Module.FS||window.FS}get MEMFS(){return this.Module.MEMFS||this.FS.filesystems.MEMFS}get HEAP8(){return this.Module.HEAP8||self.HEAP8}getStore(t){var e=t.mountpoint;if(e&&this.pathinfo[e])return this.Store.table(this.pathinfo[e])}mount(t){return this.ready.push(this.syncfs(t)),this.MEMFS.mount.apply(null,arguments)}async syncfs(t,e,s){let n,i=this,r=i.getStore(t);return r&&(t.isReady?n=await i.syncWrite(r,t):(n=await this.loadFile(r).catch((t=>alert(t))),t.isReady=!0)),location.host,e&&e instanceof Function&&e("ok"),s&&s instanceof Function&&s("ok"),n}async loadFile(t){let e=this;return Object.entries(await t.cursor()).map((t=>e.storeLocalEntry(t[0],t[1]))).join("\n")}IsOnSync=!1;syncUpdate(t,e){if(!(t&&t.node&&t.node.mount)||this.toRegExp(t.node.mount.mountpoint)){if(this.IsOnSync=!0,null!=t.fd)return clearTimeout(this.Timer),this.Timer=setTimeout((()=>this.syncUpdate(t,!0)),500);this.IsOnSync=!1,this.FS.syncfs((()=>{}))}}setMEMFS(t){let e=this;this.MEMFS?t||(t=e.MEMFS):Object.defineProperty(this.Module,"MEMFS",{get:()=>t}),t.stream_ops.write=function(t,s,n,i,r,a){if(e.HEAP8&&s.buffer===e.HEAP8.buffer&&(a=!1),!i)return 0;var o=t.node;if(o.timestamp=Date.now(),s.subarray&&(!o.contents||o.contents.subarray)){if(a)return o.contents=s.subarray(n,n+i),o.usedBytes=i,i;if(0===o.usedBytes&&0===r)return o.contents=new Uint8Array(s.subarray(n,n+i)),o.usedBytes=i,e.syncUpdate(t),i;if(r+i<=o.usedBytes)return o.contents.set(s.subarray(n,n+i),r),i}if(e.MEMFS.expandFileStorage(o,r+i),o.contents.subarray&&s.subarray)o.contents.set(s.subarray(n,n+i),r);else for(var c=0;c<i;c++)o.contents[r+c]=s[n+c];return o.usedBytes=Math.max(o.usedBytes,r+i),i},t.stream_ops.msync=function(t){},t.ops_table&&(t.ops_table.file.stream.write=t.stream_ops.write),t.ops_table&&(t.ops_table.file.stream.msync=t.stream_ops.msync),t.node_ops.unlink=function(t,s){if(delete t.contents[s],t.mount&&t.mount.isReady&&e.toRegExp(t.mount.mountpoint))return clearTimeout(e.Timer),e.Timer=setTimeout((()=>e.FS.syncfs((()=>{}))),500)},t.ops_table&&(t.ops_table.dir.node.unlink=t.node_ops.unlink)}setSyncEvent(){var t=this;t.FS.trackingDelegate.onDeletePath=function(e){if(t.toRegExp(e))return clearTimeout(t.Timer),t.Timer=setTimeout((()=>t.FS.syncfs((()=>{}))),500)},t.FS.trackingDelegate.onWriteToFile=function(e){if(t.toRegExp(e))return clearTimeout(t.Timer),t.Timer=setTimeout((()=>t.FS.syncfs((()=>{}))),500)}}async syncWrite(t,e){var s=this;let n=this.getLocalList(e.mountpoint,!0),i=await this.getRemoteList(t),r=[],a=[],o=[];if(Object.entries(n).forEach((t=>{(!i[t[0]]||t[1]>i[t[0]])&&r.push(t[0])})),Object.entries(i).forEach((t=>{n[t[0]]||a.push(t[0])})),r.length||a.length){var c=await t.write;r.length&&(r=r.sort().map((t=>new Promise((e=>c.put(s.loadLocalEntry(t),t).addEventListener("success",(function(s){e("indexdb write:"+t)}))))))),a.length&&(a=a.sort().map((t=>new Promise((e=>c.delete(t).addEventListener("success",(function(s){e("indexdb delete::"+t)}))))))),o=o.concat(await Promise.all(r)).concat(await Promise.all(a))}return this.log&&this.log(IsReady,o),o.join("\n")}loadLocalEntry(t){let e,s,n=this,i=n.FS;return i.analyzePath(t).exists?(s=i.lookupPath(t).node,e=i.stat(t),i.isDir(e.mode)?{timestamp:e.mtime,mode:e.mode}:i.isFile(e.mode)?(s.contents=n.getFileDataAsTypedArray(s),{timestamp:e.mtime,mode:e.mode,contents:s.contents}):"node type not supported"):t+" is exists"}storeLocalEntry(t,e){let s=this.FS;if(e&&e.mode){if(s.isDir(e.mode))!s.analyzePath(t).exists&&s.createPath("/",t,!0,!0);else{if(!s.isFile(e.mode))throw"node type not supported";{let n=t&&t.split("/").slice(0,-1).join("/");n&&!s.analyzePath(n).exists&&s.createPath("/",n,!0,!0),s.writeFile(t,e.contents,{canOwn:!0,encoding:"binary"})}}return s.chmod(t,e.mode),s.utime(t,e.timestamp,e.timestamp),"FS write:"+t}}removeLocalEntry(t){let e=this.FS;if(e.analyzePath(t).exists){var s=e.stat(t);return e.isDir(s.mode)?e.rmdir(t):e.isFile(s.mode)&&e.unlink(t),"FS unlink:"+t}return t+"is not exists"}async getRemoteList(t,e){let s=await t.cursor("timestamp");return e&&e(s),s}getLocalList(t,e){t=t||"/";let s=this,n=s.FS,i={},r=[".",".."].concat("/"==t?["dev","tmp","proc"]:[]),a=t=>!e||!r.includes(t),o=t=>e=>s.join2(t,e),c=s.stat(t)&&n.readdir(t).filter(a).map(o(t));if(c){for(;c.length;){let r=c.shift();if(!e&&r==t)continue;if(!e&&r==t)continue;let u=s.stat(r);s.Filter&&s.Filter(r)||u&&(n.isDir(u.mode)||(i[r]=u.mtime),n.isDir(u.mode)&&e&&c.push.apply(c,n.readdir(r).filter(a).map(o(r))))}return i}}stat(t){let e=this.FS,s=e.analyzePath(t);if(s.exists&&s.object.node_ops&&s.object.node_ops.getattr)return e.stat(t)}getFileDataAsTypedArray(t){return t.contents?t.contents.subarray?t.contents.subarray(0,t.usedBytes):new Uint8Array(t.contents):new Uint8Array}join(){var t=Array.prototype.slice.call(arguments,0);return this.normalize(t.join("/"))}join2(t,e){return this.normalize(t+"/"+e)}normalize(t){var e="/"===t.charAt(0),s="/"===t.substring(-1);return(t=this.normalizeArray(t.split("/").filter((t=>!!t)),!e).join("/"))||e||(t="."),t&&s&&(t+="/"),(e?"/":"")+t}normalizeArray(t,e){for(var s=0,n=t.length-1;n>=0;n--){var i=t[n];"."===i?t.splice(n,1):".."===i?(t.splice(n,1),s++):s&&(t.splice(n,1),s--)}if(e)for(;s;s--)t.unshift("..");return t}ReadFile(t){if(this.FS.analyzePath(t).exists)return this.FS.readFile(t)}MKFILE(t,e,s){if(!this.Module)return;let n=this.FS,i=t.split("/");if(i=i.length?i.slice(0,-1).join("/"):"/",!n.analyzePath(i).exists){let t=i.split("/").slice(0,-1).join("/");n.analyzePath(t).exists||n.createPath("/",t,!0,!0),n.createPath("/",i,!0,!0)}"string"==typeof e&&(e=(new TextEncoder).encode(e)),s?(n.analyzePath(t).exists&&n.unlink(t),n.writeFile(t,e,{encoding:"binary"})):n.analyzePath(t).exists||n.writeFile(t,e,{encoding:"binary"})}toRegExp(t){var e=!1;return this.RegExpPaths.forEach((s=>s.test(t)&&(e=!0))),e}getIndexedDB(t){var e=this;return e._DB=new Promise((s=>{var n=indexedDB.open(t||e.dbName);n.onupgradeneeded=function(t){var s=t.target.result;Object.keys(e.pathinfo).forEach((t=>{s.objectStoreNames.contains(t)||s.createObjectStore(t).createIndex("timestamp","timestamp",{unique:!1})}))},n.onsuccess=function(t){s(n.result)}})),new class{async transaction(t,s){return(await e._DB).transaction([t],s?void 0:"readwrite").objectStore(t)}tables={};table(t){return this.tables[t]?this.tables[t]:new class{constructor(t,e){Object.assign(this,{IDB:t,table:e}),t.tables[e]=this}async transaction(e){return this.IDB.transaction(t,e)}get read(){return this.transaction(!0)}get write(){return this.transaction(!1)}put(t,e){return new Promise((async s=>{(await this.write).put(t,e).onsuccess=function(t){s(t.target.result)}}))}delete(t){return new Promise((async e=>{(await this.write).delete(data,t).onsuccess=function(t){e(t.target.result)}}))}get(t){return new Promise((async e=>{(await this.read).get(data,t).onsuccess=function(t){e(t.target.result)}}))}cursor(t,e,s){return new Promise((async n=>{var i={},r=await this.read;(t?r.index(t).openKeyCursor(e,s):r.openCursor(e,s)).onsuccess=function(t){var e=t.target.result;if(e){var{primaryKey:s,key:r,value:a}=e;i[s]=void 0===a?r:a,e.continue()}else n(i)}}))}}(this,t)}}}}